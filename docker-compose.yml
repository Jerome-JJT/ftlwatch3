version: "3.7"


services:

  flyway:
    image: flyway/flyway

    stdin_open: true # docker run -i
    tty: true        # docker run -t

    volumes:
      - ./sql:/flyway/sql

    networks:
      - back

    environment:
      DATABASE_HOST: 'db'
      DATABASE_PORT: '5432'

      POSTGRES_DB: ${DATABASE_DB}
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}

    entrypoint: "bash"
    # entrypoint: "bash /flyway/sql/_myflyway.sh migrate"

  rabbit:
    build: ./_build/rabbit
    hostname: rabbit

    volumes:
      - rabbit_data:/var/lib/rabbitmq

    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS}

    networks:
      - back

    ports:
      - "9999:15672"


  db:
    image: postgres:14.2

    volumes:
      - main_db:/var/lib/postgresql/data/

    networks:
      - back

    environment:
      POSTGRES_DB: ${DATABASE_DB}
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}

  adminer:
    image: adminer

    # depends_on:
    #   - postgres

    # volumes:
    #   - ./adminer:/var/www/html

    networks:
      - back

  back:
    build: ./_build/php
    # image: httpd:2.4.57-alpine
    depends_on:
      - db

    volumes:
      - ./secure_static:/secure_static
      - ./back:/var/www/html

    networks:
      - back
      - front
      - logging_logstash

    # ports:
    #   - "8888:80"

    environment:
      DATABASE_CONNECT: 'pgsql'
      DATABASE_HOST: 'db'
      DATABASE_PORT: '5432'

      DATABASE_DB: ${DATABASE_DB}
      DATABASE_USER: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

      CALLBACK_URL: ${CALLBACK_URL}

      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}

      API_UID: ${API_FRONT_UID}
      API_SECRET: ${API_FRONT_SECRET}
  
    working_dir: /var/www/html


  front:
    build: ./_build/react

    # ports:
    #  - "8080:5173"
    #  - "8443:443"

    volumes:
      - ./site:/app

    networks:
      - front

    # environment:
      # API_UID: ${API_FRONT_UID}

    working_dir: /app

  api:
    build: ./_build/api
    #restart: on-failure
    
    stdin_open: true # docker run -i
    tty: true        # docker run -t

    volumes:
      - ./secure_static:/secure_static
      - ./api:/app

    networks:
      - back
      - logging_logstash

    env_file:
     - .env

    environment:
      DATABASE_CONNECT: 'pgsql'
      DATABASE_HOST: 'db'
      DATABASE_PORT: '5432'

      DATABASE_DB: ${DATABASE_DB}
      DATABASE_USER: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}
      
      API_UID: ${API_BACK_UID}
      API_SECRET: ${API_BACK_SECRET}

    working_dir: /app


  nginx:
    build: ./_build/nginx

    depends_on:
      - front
      - back

    volumes:
      - ./static:/var/www/static

    networks:
      - front
      - back


networks:
  front:
  back:
  logging_logstash:
    name: logging_logstash
    external: true

volumes:
  main_db:
  rabbit_data:


